<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>nl.bzk.brp</groupId>
        <artifactId>brp-parent</artifactId>
        <version>93</version>
    </parent>
    <artifactId>brp-proeftuin-distributie</artifactId>
    <packaging>pom</packaging>
    <version>94-SNAPSHOT</version>

    <name>BRP Proeftuin Distributie</name>
    <description>
        Project specifiek voor het maken van een proeftuin-distributie bestand t.b.v. de BRP Service(s).
        Ook levert dit project de juiste vulling voor het autaut-schema mbt de afnemers.
    </description>

    <properties>
        <brp.release.versie>93</brp.release.versie>

        <!-- Properties die overschreven worden vanuit Jenkins/command-line -->
        <dburl>jdbc:hsqldb:file:${project.build.directory}/db;shutdown=true;</dburl>
        <dbusername>brp</dbusername>
        <dbpassword>brp</dbpassword>
        <dbdriver>org.hsqldb.jdbc.JDBCDriver</dbdriver>
    </properties>

    <build>
        <plugins>
            <plugin>
                <groupId>org.codehaus.mojo</groupId>
                <artifactId>build-helper-maven-plugin</artifactId>
                <executions>
                    <execution>
                        <id>parse-version</id>
                        <goals>
                            <goal>parse-version</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-dependency-plugin</artifactId>
                <executions>
                    <execution>
                        <id>unpack-distributie-zip-synchronisatie-attendering</id>
                        <goals>
                            <goal>unpack</goal>
                        </goals>
                        <phase>prepare-package</phase>
                        <configuration>
                            <artifactItems>
                                <artifactItem>
                                    <groupId>nl.bzk.brp</groupId>
                                    <artifactId>brp-distributie</artifactId>
                                    <version>${brp.release.versie}</version>
                                    <classifier>software-synchronisatie-attendering</classifier>
                                    <type>zip</type>
                                    <overWrite>true</overWrite>
                                    <outputDirectory>${project.build.directory}</outputDirectory>
                                </artifactItem>
                            </artifactItems>
                        </configuration>
                    </execution>
                    <execution>
                        <id>unpack-distributie-zip-bevraging</id>
                        <goals>
                            <goal>unpack</goal>
                        </goals>
                        <phase>prepare-package</phase>
                        <configuration>
                            <artifactItems>
                                <artifactItem>
                                    <groupId>nl.bzk.brp</groupId>
                                    <artifactId>brp-distributie</artifactId>
                                    <version>${brp.release.versie}</version>
                                    <classifier>software-bevraging</classifier>
                                    <type>zip</type>
                                    <overWrite>true</overWrite>
                                    <outputDirectory>${project.build.directory}</outputDirectory>
                                </artifactItem>
                            </artifactItems>
                        </configuration>
                    </execution>
                    <execution>
                        <id>unpack-distributie-zip-bijhouding</id>
                        <goals>
                            <goal>unpack</goal>
                        </goals>
                        <phase>prepare-package</phase>
                        <configuration>
                            <artifactItems>
                                <artifactItem>
                                    <groupId>nl.bzk.brp</groupId>
                                    <artifactId>brp-distributie</artifactId>
                                    <version>${brp.release.versie}</version>
                                    <classifier>software-bijhouding</classifier>
                                    <type>zip</type>
                                    <overWrite>true</overWrite>
                                    <outputDirectory>${project.build.directory}</outputDirectory>
                                </artifactItem>
                            </artifactItems>
                        </configuration>
                    </execution>
                    <execution>
                        <id>unpack-distributie-docs-zip-attendering-synchronisatie</id>
                        <goals>
                            <goal>unpack</goal>
                        </goals>
                        <phase>prepare-package</phase>
                        <configuration>
                            <artifactItems>
                                <artifactItem>
                                    <groupId>nl.bzk.brp</groupId>
                                    <artifactId>brp-distributie</artifactId>
                                    <version>${brp.release.versie}</version>
                                    <classifier>docs-installatie-synchronisatie-attendering</classifier>
                                    <type>zip</type>
                                    <overWrite>true</overWrite>
                                    <outputDirectory>${project.build.directory}</outputDirectory>
                                </artifactItem>
                            </artifactItems>
                        </configuration>
                    </execution>
                    <execution>
                        <id>unpack-distributie-docs-zip-bevraging</id>
                        <goals>
                            <goal>unpack</goal>
                        </goals>
                        <phase>prepare-package</phase>
                        <configuration>
                            <artifactItems>
                                <artifactItem>
                                    <groupId>nl.bzk.brp</groupId>
                                    <artifactId>brp-distributie</artifactId>
                                    <version>${brp.release.versie}</version>
                                    <classifier>docs-installatie-bevraging</classifier>
                                    <type>zip</type>
                                    <overWrite>true</overWrite>
                                    <outputDirectory>${project.build.directory}</outputDirectory>
                                </artifactItem>
                            </artifactItems>
                        </configuration>
                    </execution>
                    <execution>
                        <id>unpack-distributie-docs-zip-bijhouding</id>
                        <goals>
                            <goal>unpack</goal>
                        </goals>
                        <phase>prepare-package</phase>
                        <configuration>
                            <artifactItems>
                                <artifactItem>
                                    <groupId>nl.bzk.brp</groupId>
                                    <artifactId>brp-distributie</artifactId>
                                    <version>${brp.release.versie}</version>
                                    <classifier>docs-installatie-bijhouding</classifier>
                                    <type>zip</type>
                                    <overWrite>true</overWrite>
                                    <outputDirectory>${project.build.directory}</outputDirectory>
                                </artifactItem>
                            </artifactItems>
                        </configuration>
                    </execution>
                    <execution>
                        <id>unpack-db-proeftuin</id>
                        <goals>
                            <goal>unpack</goal>
                        </goals>
                        <phase>generate-sources</phase>
                        <configuration>
                            <artifactItems>
                                <artifactItem>
                                    <groupId>nl.bzk.brp.algemeen.opslag</groupId>
                                    <artifactId>brp-algemeen-opslag-database</artifactId>
                                    <version>${brp.release.versie}</version>
                                    <overWrite>false</overWrite>
                                    <outputDirectory>${project.build.directory}/brp-db</outputDirectory>
                                    <includes>**/*.*</includes>
                                </artifactItem>
                            </artifactItems>
                        </configuration>
                    </execution>
                    <execution>
                        <id>copy-postgresql</id>
                        <phase>package</phase>
                        <goals>
                            <goal>copy</goal>
                        </goals>
                        <configuration>
                            <artifactItems>
                                <artifactItem>
                                    <groupId>org.postgresql</groupId>
                                    <artifactId>postgresql</artifactId>
                                    <version>${postgres.version}</version>
                                    <type>jar</type>
                                    <overWrite>false</overWrite>
                                    <outputDirectory>
                                        ${project.build.directory}/drivers
                                    </outputDirectory>
                                </artifactItem>
                            </artifactItems>
                            <outputDirectory>
                                ${project.build.directory}/drivers
                            </outputDirectory>
                            <overWriteReleases>false</overWriteReleases>
                            <overWriteSnapshots>true</overWriteSnapshots>
                        </configuration>
                    </execution>
                    <execution>
                        <id>copy-bezemwagen</id>
                        <phase>package</phase>
                        <goals>
                            <goal>copy</goal>
                        </goals>
                        <configuration>
                            <artifactItems>
                                <artifactItem>
                                    <groupId>nl.bzk.brp.levering.services</groupId>
                                    <artifactId>brp-levering-services-bezemwagen</artifactId>
                                    <version>${brp.release.versie}</version>
                                    <type>war</type>
                                    <overWrite>false</overWrite>
                                </artifactItem>
                            </artifactItems>
                            <outputDirectory>
                                ${project.build.directory}/bezemwagen
                            </outputDirectory>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <artifactId>maven-assembly-plugin</artifactId>
                <executions>
                    <execution>
                        <id>make-assembly</id>
                        <!-- this is used for inheritance merges -->
                        <phase>package</phase>
                        <!-- bind to the packaging phase -->
                        <goals>
                            <goal>single</goal>
                        </goals>
                        <configuration>
                            <descriptors>
                                <descriptor>src/main/assembly/distributie-zip.xml</descriptor>
                            </descriptors>
                        </configuration>
                    </execution>
                    <execution>
                        <phase>package</phase>
                        <goals>
                            <goal>single</goal>
                        </goals>
                        <configuration>
                            <descriptors>
                                <descriptor>src/main/assembly/autaut-zip.xml</descriptor>
                            </descriptors>
                        </configuration>
                    </execution>
                </executions>
            </plugin>

            <!-- Genereert de SQL files voor de afnemers, elke execution genereert een SQL file voor een
             specifieke afnemer.-->
            <plugin>
                <groupId>org.liquibase</groupId>
                <artifactId>liquibase-maven-plugin</artifactId>
                <executions>
                    <execution>
                        <id>create-sql-proeftuin-utrecht</id>
                        <phase>process-classes</phase>
                        <goals>
                            <goal>updateSQL</goal>
                        </goals>
                        <configuration>
                            <changeLogFile>${basedir}/src/main/afnemer-toevoegen-changeset/proeftuin-gemboxx-utrecht.xml</changeLogFile>
                            <migrationSqlOutputFile>${project.build.directory}/autaut/proeftuin-utrecht.sql</migrationSqlOutputFile>
                            <skip>false</skip>
                        </configuration>
                    </execution>
                    <execution>
                        <id>create-sql-proeftuin-haarlem</id>
                        <phase>process-classes</phase>
                        <goals>
                            <goal>updateSQL</goal>
                        </goals>
                        <configuration>
                            <changeLogFile>${basedir}/src/main/afnemer-toevoegen-changeset/proeftuin-procura-haarlem.xml</changeLogFile>
                            <migrationSqlOutputFile>${project.build.directory}/autaut/proeftuin-haarlem.sql</migrationSqlOutputFile>
                            <skip>false</skip>
                        </configuration>
                    </execution>
                    <execution>
                        <id>create-sql-proeftuin-groningen</id>
                        <phase>process-classes</phase>
                        <goals>
                            <goal>updateSQL</goal>
                        </goals>
                        <configuration>
                            <changeLogFile>${basedir}/src/main/afnemer-toevoegen-changeset/proeftuin-pinkroccade-groningen.xml</changeLogFile>
                            <migrationSqlOutputFile>${project.build.directory}/autaut/proeftuin-groningen.sql</migrationSqlOutputFile>
                            <skip>false</skip>
                        </configuration>
                    </execution>
                    <execution>
                        <id>create-sql-proeftuin-rotterdam</id>
                        <phase>process-classes</phase>
                        <goals>
                            <goal>updateSQL</goal>
                        </goals>
                        <configuration>
                            <changeLogFile>${basedir}/src/main/afnemer-toevoegen-changeset/proeftuin-centric-rotterdam.xml</changeLogFile>
                            <migrationSqlOutputFile>${project.build.directory}/autaut/proeftuin-rotterdam.sql</migrationSqlOutputFile>
                            <skip>false</skip>
                        </configuration>
                    </execution>
                    <execution>
                        <id>create-sql-proeftuin-maastricht</id>
                        <phase>process-classes</phase>
                        <goals>
                            <goal>updateSQL</goal>
                        </goals>
                        <configuration>
                            <changeLogFile>${basedir}/src/main/afnemer-toevoegen-changeset/proeftuin-opengba-maastricht.xml</changeLogFile>
                            <migrationSqlOutputFile>${project.build.directory}/autaut/proeftuin-maastricht.sql</migrationSqlOutputFile>
                            <skip>false</skip>
                        </configuration>
                    </execution>
                    <execution>
                        <id>create-sql-proeftuin-nijmegen</id>
                        <phase>process-classes</phase>
                        <goals>
                            <goal>updateSQL</goal>
                        </goals>
                        <configuration>
                            <changeLogFile>${basedir}/src/main/afnemer-toevoegen-changeset/proeftuin-tt-nijmegen.xml</changeLogFile>
                            <migrationSqlOutputFile>${project.build.directory}/autaut/proeftuin-nijmegen.sql</migrationSqlOutputFile>
                            <skip>false</skip>
                        </configuration>
                    </execution>
                    <execution>
                        <id>create-sql-proeftuin-denhaag</id>
                        <phase>process-classes</phase>
                        <goals>
                            <goal>updateSQL</goal>
                        </goals>
                        <configuration>
                            <changeLogFile>${basedir}/src/main/afnemer-toevoegen-changeset/proeftuin-brptest-denhaag.xml</changeLogFile>
                            <migrationSqlOutputFile>${project.build.directory}/autaut/proeftuin-denhaag.sql</migrationSqlOutputFile>
                            <skip>false</skip>
                        </configuration>
                    </execution>
                    <execution>
                        <id>create-sql-proeftuin-alkmaar</id>
                        <phase>process-classes</phase>
                        <goals>
                            <goal>updateSQL</goal>
                        </goals>
                        <configuration>
                            <changeLogFile>${basedir}/src/main/afnemer-toevoegen-changeset/proeftuin-brptest-alkmaar.xml</changeLogFile>
                            <migrationSqlOutputFile>${project.build.directory}/autaut/proeftuin-alkmaar.sql</migrationSqlOutputFile>
                            <skip>false</skip>
                        </configuration>
                    </execution>
                </executions>
                <configuration>
                    <promptOnNonLocalDatabase>false</promptOnNonLocalDatabase>
                    <outputFileEncoding>UTF-8</outputFileEncoding>

                    <!-- Alles in 1 database in dit profiel -->
                    <driver>${dbdriver}</driver>
                    <url>${dburl}</url>
                    <username>${dbusername}</username>
                    <password>${dbpassword}</password>
                    <skip>false</skip>
                </configuration>
                <dependencies>
                    <dependency>
                        <groupId>org.hsqldb</groupId>
                        <artifactId>hsqldb</artifactId>
                        <version>${hsqldb.version}</version>
                    </dependency>
                </dependencies>
            </plugin>

            <!-- Ruimt overbodige regels op in de gegenereerde SQL bestanden. -->
            <plugin>
                <groupId>com.google.code.maven-replacer-plugin</groupId>
                <artifactId>replacer</artifactId>
                <version>1.5.2</version>
                <executions>
                    <execution>
                        <phase>prepare-package</phase>
                        <goals>
                            <goal>replace</goal>
                        </goals>
                    </execution>
                </executions>
                <configuration>
                    <basedir>${project.build.directory}</basedir>
                    <includes>
                        <include>**/autaut/proeftuin-*.sql</include>
                    </includes>
                    <replacements>
                        <replacement>
                            <token>CREATE TABLE DATABASECHANGELOG.*\);</token>
                            <value />
                        </replacement>
                        <replacement>
                            <token>DELETE FROM DATABASECHANGELOGLOCK;</token>
                            <value />
                        </replacement>
                        <replacement>
                            <token>INSERT INTO DATABASECHANGELOG.*\);</token>
                            <value />
                        </replacement>
                    </replacements>
                </configuration>
            </plugin>

            <!-- Schrijft verschillende sql-bestanden achter elkaar in 1 bestand,
            in de volgorde waarop deze uitgevoerd dienen te worden. (concatenatie). -->
            <plugin>
                <artifactId>maven-antrun-plugin</artifactId>
                <version>1.7</version>
                <executions>
                    <execution>
                        <phase>prepare-package</phase>
                        <configuration>
                            <target>
                                <concat destfile="${project.basedir}/target/proeftuin-autaut.sql" append="true">
                                    <string>BEGIN;${line.separator}</string>
                                    <filelist dir="${project.basedir}/target/brp-db/autaut" files="afnemers-verwijderen.sql" />
                                    <fileset dir="${project.basedir}/target/autaut" includes="*.sql" />
                                    <filelist dir="${project.basedir}/target/brp-db/autaut" files="afnemerindicaties-koppelen-aan-abonnement.sql" />
                                    <!-- TODO: inschakelen bij nieuwe versie brp-db, tot die tijd is dit in proeftuin db generator project als custom change -->
                                    <!--<filelist dir="${project.basedir}/target/brp-db/autaut" files="authenticatiemiddel-koppelen-aan-toegangabonnement.sql" />-->
                                    <string>${line.separator}COMMIT;</string>
                                </concat>
                            </target>
                        </configuration>
                        <goals>
                            <goal>run</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>

        </plugins>
    </build>

    <dependencies>
        <!-- Database -->
        <dependency>
            <groupId>nl.bzk.brp.algemeen.opslag</groupId>
            <artifactId>brp-algemeen-opslag-database</artifactId>
            <version>${brp.release.versie}</version>
        </dependency>

        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <version>${postgres.version}</version>
        </dependency>

        <!-- Logging -->
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
        </dependency>
        <dependency>
            <groupId>org.apache.logging.log4j</groupId>
            <artifactId>log4j-slf4j-impl</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.apache.logging.log4j</groupId>
            <artifactId>log4j-core</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <scm>
        <connection>scm:svn:https://www.modernodam.nl/svn/brp-code/trunk/build/proeftuin-distributie</connection>
    </scm>

</project>
