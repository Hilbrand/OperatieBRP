<?xml version = "1.0" encoding = "UTF-8"?>
<jbossesb xmlns="http://anonsvn.labs.jboss.com/labs/jbossesb/trunk/product/etc/schemas/xml/jbossesb-1.0.1.xsd"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://anonsvn.labs.jboss.com/labs/jbossesb/trunk/product/etc/schemas/xml/jbossesb-1.0.1.xsd http://anonsvn.jboss.org/repos/labs/labs/jbossesb/trunk/product/etc/schemas/xml/jbossesb-1.0.1.xsd"
    parameterReloadSecs="5">

    <providers>
        <jms-provider name="JBossMessageing" connection-factory="ConnectionFactory">
            <jms-bus busid="quickstartGatewayChannel">
                <jms-message-filter dest-type="QUEUE" dest-name="queue/quickstart_security_saml_gw"/>
            </jms-bus>
            <jms-bus busid="quickstartEsbChannel">
                <jms-message-filter dest-type="QUEUE" dest-name="queue/quickstart_security_saml_esb"/>
            </jms-bus>
        </jms-provider>

		<jbr-provider name="JBR-Http" protocol="http" host="localhost">
			<jbr-bus busid="Http-1" port="9888" />
		</jbr-provider>

    </providers>

    <services>

		 <service category="SamlSecurityQuickstart" name="issueTokenService" 
			invmScope="GLOBAL"
			description="This service demonstrates how a service can be configured to issue and validate a security token">

			<security moduleName="saml-issue-token" callbackHandler="org.jboss.soa.esb.services.security.auth.login.JBossSTSIssueCallbackHandler">
				<!-- disable the security context timeout so that our security context is re-evaluated -->
				<property name="org.jboss.soa.esb.services.security.contextTimeout" value="0"/>
			</security>

            <listeners>
                <jms-listener name="JMSGatewayListener" busidref="quickstartGatewayChannel" is-gateway="true"/>
				<jbr-listener name="Http-Gateway" busidref="Http-1" is-gateway="true">
					<property name="synchronous" value="false"/>
				</jbr-listener>
            </listeners>

            <actions mep="OneWay">
	
				<!-- Uncomment if you'd like to print the current Subject
				<action name="printSubject" class="org.jboss.soa.esb.samples.quickstart.securitysaml.DisplaySubjectAction"/>
				-->
 
				<action name="routeAction"  class="org.jboss.soa.esb.actions.StaticRouter">
                    <property name="destinations">
                       <route-to service-category="SamlSecurityQuickstart" service-name="securedSamlService"/>
					</property>
                </action>

            </actions>
        </service>

        <service category="SamlSecurityQuickstart" name="securedSamlService" 
			invmScope="GLOBAL"
			description="This service demonstrates that an ESB service can be configured to only validate a security token.">

			<security moduleName="saml-validate-token" callbackHandler="org.jboss.soa.esb.services.security.auth.login.JBossSTSTokenCallbackHandler">
				<!-- disable the security context timeout so that our security context is re-evaluated -->
				<property name="org.jboss.soa.esb.services.security.contextTimeout" value="0"/>
			</security>

            <actions mep="OneWay">

				<!-- Uncomment if you'd like to print the current Subject
				<action name="printSubject" class="org.jboss.soa.esb.samples.quickstart.securitysaml.DisplaySubjectAction"/>
				-->

				<action name="routeAction"  class="org.jboss.soa.esb.actions.StaticRouter">
                    <property name="destinations">
                       <route-to service-category="SamlSecurityQuickstart" service-name="sendExternal"/>
					</property>
                </action>

            </actions>
        </service>

		<service category="SamlSecurityQuickstart" name="sendExternal" 
			invmScope="GLOBAL"
			description="This service demonstrates that an ESB service can be configured to only validate a security token and call an external WS with the security token.">

			<security moduleName="saml-validate-token" callbackHandler="org.jboss.soa.esb.services.security.auth.login.JBossSTSTokenCallbackHandler"/>

            <actions mep="OneWay">

				<!-- Uncomment if you'd like to print the current Subject
				<action name="printSubject" class="org.jboss.soa.esb.samples.quickstart.securitysaml.DisplaySubjectAction"/>
				-->

				<action name="addSamlSecurityHeader" class="org.jboss.soa.esb.smooks.SmooksAction">
                    <property name="smooksConfig" value="/smooks/smooks-saml-injector.xml" />
                </action>

                <action name="JBossWSAdapter" class="org.jboss.soa.esb.actions.soap.SOAPProcessor">
                    <property name="jbossws-endpoint" value="GoodbyeWorldWS"/>
                </action>

            </actions>
        </service>

    </services>

</jbossesb>
